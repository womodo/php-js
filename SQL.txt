CREATE TABLE IF NOT EXISTS `m_image` (
  `ID` int(11) NOT NULL AUTO_INCREMENT,
  `IMG_TYPE` char(1) NOT NULL,
  `FILE_PATH` varchar(200) NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE IF NOT EXISTS `t_select` (
  `ID` int(11) NOT NULL,
  `FILE_PATH` varchar(200) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;




SELECT
   m.ITEM_CD,
   ( SELECT MAX(ISSUE_DATE) FROM t_issue
	   WHERE ITEM_CD = m.ITEM_CD 
	   GROUP BY ITEM_CD ) AS MAX_ISSUE_DATE,
   ( SELECT SUM(QTY) FROM t_act
	   WHERE ITEM_CD = m.ITEM_CD
	     AND ACT_DATE >= MAX_ISSUE_DATE
	   GROUP BY ITEM_CD ) AS SUM_QTY
FROM
   m_item AS m;



SELECT 
l.ITEM_CD
,l.MOLD_ITEM_CD
,m.STATUS
,m.MOLD_QTY
,l.PIN_POSITION_NO
,p.PIN_ID
,p.PIN_NAME
,p.SLOPE_FLG
,( SELECT MAX(ISSUE_DATE) FROM t_pin_qty
   WHERE ITEM_CD = l.ITEM_CD
   AND MOLD_ITEM_CD = l.MOLD_ITEM_CD
   AND CASE
         WHEN l.PIN_POSITION_NO IS NULL THEN PIN_POSITION_NO IS NULL
         ELSE PIN_POSITION_NO = l.PIN_POSITION_NO
       END
   AND ISSUE_TYPE = '1'
	GROUP BY ITEM_CD,MOLD_ITEM_CD,PIN_POSITION_NO ) AS MAX_ISSUE_DATE
,( SELECT SUM(ACT_QTY) FROM t_act_qty
   WHERE ITEM_CD = l.ITEM_CD
   AND MOLD_ITEM_CD = l.MOLD_ITEM_CD
   AND ACT_DATE >= MAX_ISSUE_DATE
   AND p.SLOPE_FLG = '0'
   GROUP BY ITEM_CD,MOLD_ITEM_CD ) AS SUM_ACT_QTY
FROM m_pin AS p
LEFT JOIN m_pin_link AS l
ON p.PIN_ID = l.PIN_ID
LEFT JOIN m_mold AS m
ON l.ITEM_CD = m.ITEM_CD
AND l.MOLD_ITEM_CD = m.MOLD_ITEM_CD

WHERE 0 = 0 
-- AND STATUS = '0'

ORDER BY ITEM_CD,MOLD_ITEM_CD,PIN_POSITION_NO,PIN_ID
